
services:
  freshrss:
    image: freshrss/freshrss:latest
    container_name: freshrss
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - CRON_MIN=${CRON_MIN:-*/720}
    ports:
      - "8080:80"
    volumes:
      - ./data/freshrss:/var/www/FreshRSS/data
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  rss-sync:
    build:
      context: ./apps/freshrss-search
      dockerfile: Dockerfile
    image: rss-sync-worker
    container_name: rss_sync_worker
    restart: unless-stopped
    mem_limit: 1g
    environment:
      # --- SiliconFlow Config ---
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - SILICONFLOW_BASE_URL=${SILICONFLOW_BASE_URL:-https://api.siliconflow.cn/v1}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-Qwen/Qwen3-Embedding-8B}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-4096}

      # --- Tuning Params ---
      - CHUNK_SIZE=${CHUNK_SIZE:-200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-100}
      - SEARCH_THRESHOLD=${SEARCH_THRESHOLD:-1} # [0, 2] 越小越严格
      - SEARCH_CANDIDATE_MULTIPLIER=${SEARCH_CANDIDATE_MULTIPLIER:-20}
      - SEARCH_CANDIDATE_CAP=${SEARCH_CANDIDATE_CAP:-200}
      - RERANK_ENABLED=${RERANK_ENABLED:-0}
      - RERANK_MODEL=${RERANK_MODEL:-BAAI/bge-reranker-v2-m3}
      - RERANK_CANDIDATES=${RERANK_CANDIDATES:-200}
      - RERANK_TIMEOUT_SECONDS=${RERANK_TIMEOUT_SECONDS:-15}
      - RERANK_MAX_DOC_CHARS=${RERANK_MAX_DOC_CHARS:-2000}
      - CHECK_INTERVAL=${CHECK_INTERVAL:-36000}
      - RETENTION_DAYS=${RETENTION_DAYS:-90}
      - LANCEDB_URI=${LANCEDB_URI:-/app/lancedb_data/freshrss}
      - FRESHRSS_DATA_DIR=${FRESHRSS_DATA_DIR:-/app/data}
      - FRESHRSS_SQLITE_PATH=${FRESHRSS_SQLITE_PATH:-}
      - EMBEDDING_BATCH_SIZE=${EMBEDDING_BATCH_SIZE:-50}
      - SYNC_ENTRY_BATCH_SIZE=${SYNC_ENTRY_BATCH_SIZE:-20}
      - SYNC_CATEGORIES=${SYNC_CATEGORIES:-macro}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
    volumes:
      # Freshrss SQLite 数据库（只读挂载）
      - ./data/freshrss:/app/data:ro
      # LanceDB 持久化目录
      - ./data/lancedb:/app/lancedb_data
      # 同步与搜索代码
      - ./apps/freshrss-search:/app/code
    working_dir: /app/code
    command: python sync_daemon.py
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  rss-bridge:
    image: rssbridge/rss-bridge
    container_name: rss-bridge
    ports:
      - "3000:80"
    volumes:
      - ./config/rss-bridge:/config
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  wechat2rss:
    image: "ttttmr/wechat2rss:latest"
    container_name: wechat2rss
    environment:
      - LIC_EMAIL=${LIC_EMAIL} # 付款时备注的邮箱
      - LIC_CODE=${LIC_CODE} # 激活码
      - RSS_HOST=${RSS_HOST:-wechat2rss:8080} # 服务器地址
      - RSS_PROXY_DISABLE_IMG=${RSS_PROXY_DISABLE_IMG:-1}
    volumes:
      - ./data/wechat2rss:/wechat2rss # 数据持久化保存
    ports:
      - "8081:8080" # 监听端口映射，例如修改到8081端口，8081:8080
    deploy: # 自动重启策略
      restart_policy:
        condition: on-failure
        max_attempts: 3
        window: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  rsshub:
    build:
      context: ./apps/rsshub-custom
      dockerfile: Dockerfile
    image: rsshub-custom
    container_name: rsshub
    restart: unless-stopped
    ports:
      - "1200:1200"
    environment:
      NODE_ENV: production
      CACHE_TYPE: redis
      REDIS_URL: "redis://redis:6379/"
      PUPPETEER_WS_ENDPOINT: "ws://browserless:3000"
      PUPPETEER_REAL_BROWSER_SERVICE: "http://real-browser:3000"
      ZSXQ_ACCESS_TOKEN: ${ZSXQ_ACCESS_TOKEN}
      SEEKINGALPHA_COOKIE: ${SEEKINGALPHA_COOKIE}
      CACHE_EXPIRE: ${CACHE_EXPIRE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1200/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis
      - browserless
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  real-browser:
    image: ghcr.io/hyoban/puppeteer-real-browser-hono
    container_name: real-browser
    restart: always
    mem_limit: 1g
    ports:
      - "3001:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  browserless:
    image: browserless/chrome
    container_name: browserless
    restart: unless-stopped
    mem_limit: 1g
    ulimits:
      core:
        hard: 0
        soft: 0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/pressure"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

  redis:
    image: redis:alpine
    container_name: rsshub-redis
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - rssnet

networks:
  rssnet:
    driver: bridge
